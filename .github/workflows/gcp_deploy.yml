name: Deploy to Cloud Run

on:
  # Allow manual deployment trigger (main branch only enforced in job condition)
  workflow_dispatch:
  # Trigger only after database migrations pipeline completes on main branch
  # This ensures migrations are applied before deployment
  workflow_run:
    workflows: ["Database Migrations"]
    branches: [main]
    types:
      - completed

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

env:
  PROJECT_ID: mobileid-478800
  REGION: us-west1
  SERVICE_NAME: mobileid

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only deploy when:
    # 1. Manual trigger on main branch
    # 2. Database Migrations workflow succeeded (branches filter already ensures main branch)
    if: |
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    environment:
      name: MobileID Backend (Google Cloud - Production)
      url: https://${{ env.SERVICE_NAME }}-${{ env.REGION }}.a.run.app

    permissions:
      contents: "read"
      id-token: "write"
      deployments: "write"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          # Use workflow_run's head_sha if triggered by workflow_run, otherwise use default
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # ---------- Build and Deploy ----------
      # Note: GitHub Deployment record is automatically created by the job-level 'environment' setting
      - name: Build and Push Container
        run: |-
          gcloud builds submit src --tag gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}

      - name: Deploy to Cloud Run
        id: deploy_cloudrun
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}
          flags: "--add-cloudsql-instances=${{ secrets.INSTANCE_CONNECTION_NAME }} --allow-unauthenticated"
          env_vars: |-
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            INSTANCE_CONNECTION_NAME=${{ secrets.INSTANCE_CONNECTION_NAME }}
            GCP_PROJECT_ID=${{ env.PROJECT_ID }}
            DJANGO_SETTINGS_MODULE=core.settings.prod

            DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
            DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
            DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}

            SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}

            ALLOWED_HOSTS=*
            DB_PROFILE=gcp
            DEBUG=False
            ENVIRONMENT=production

            CORS_ALLOWED_ORIGINS=*
            CSRF_TRUSTED_ORIGINS=https://*.run.app
            ADMIN_URL_PATH=${{ secrets.ADMIN_URL_PATH }}

      # ---------- Post-Deployment Health Check ----------
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Health Check
        id: health_check
        run: |
          SERVICE_URL="${{ steps.deploy_cloudrun.outputs.url }}"
          echo "Checking health at: $SERVICE_URL/health/"

          # Check health endpoint (primary health check)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health/" || echo "000")
          RESPONSE=$(curl -s "$SERVICE_URL/health/" || echo "{}")
          echo "Health Endpoint Response: $HTTP_CODE"
          echo "Response Body: $RESPONSE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Health check failed: /health/ returned $HTTP_CODE"
            exit 1
          fi
          echo "[PASS] Health endpoint is responding correctly"

      - name: Smoke Test - API Endpoints
        run: |
          SERVICE_URL="${{ steps.deploy_cloudrun.outputs.url }}"

          echo "Running smoke tests..."

          # Test well-known endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/.well-known/webauthn" || echo "000")
          echo "WebAuthn Well-Known: $HTTP_CODE"

          # Test API base
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/api/" || echo "000")
          echo "API Base: $HTTP_CODE"

          echo "[PASS] Smoke tests completed"

      - name: Verify Cloud Run Service Status
        run: |
          echo "Verifying Cloud Run service..."
          gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="yaml(status)"

          # Check if service is serving traffic
          SERVING=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.conditions[0].status)")
          if [ "$SERVING" != "True" ]; then
            echo "::error::Service is not in healthy state"
            exit 1
          fi
          echo "[PASS] Cloud Run service is healthy and serving traffic"

      # Note: Deployment status is automatically updated by GitHub Actions based on job result
      # The job-level 'environment' setting handles deployment record creation and status updates

      # ---------- Rollback Logic ----------
      - name: Rollback on Failure
        if: failure()
        run: |-
          echo "Deployment failed, rolling back to previous revision..."
          LAST_REVISION=$(gcloud run revisions list --service=${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --sort-by="~createTime" --limit=2 --format="value(metadata.name)" | tail -n 1)
          if [ -n "$LAST_REVISION" ]; then
            gcloud run services update-traffic ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --to-revisions=$LAST_REVISION=100
            echo "Rollback complete: now serving $LAST_REVISION"
          else
            echo "No previous revision found, skipping rollback."
          fi