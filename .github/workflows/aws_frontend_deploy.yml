name: AWS Frontend Deploy

on:
  push:
    branches: [main]
    paths:
      - "pages/**"
      - ".github/workflows/aws_frontend_deploy.yml"
      - ".github/workflows/aws_guardrails.yml"
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: aws-frontend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  guardrails:
    uses: ./.github/workflows/aws_guardrails.yml
    secrets: inherit
    with:
      aws_region: ${{ vars.AWS_REGION || 'us-west-2' }}
      expected_account_id: ${{ vars.AWS_ACCOUNT_ID || '394167325273' }}
      resource_prefix: ${{ vars.AWS_RESOURCE_PREFIX || 'i2g-mobileid-' }}
      amplify_app_name: ${{ vars.AWS_FRONTEND_AMPLIFY_APP_NAME }}
      cloudfront_comment: ${{ vars.AWS_BACKEND_CLOUDFRONT_COMMENT }}
      resource_names: ${{ vars.AWS_FRONTEND_ARTIFACT_BUCKET }}

  deploy:
    runs-on: ubuntu-latest
    needs: [guardrails]
    timeout-minutes: 35
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'us-west-2' }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
      AWS_FRONTEND_AMPLIFY_APP_ID: ${{ vars.AWS_FRONTEND_AMPLIFY_APP_ID }}
      AWS_FRONTEND_AMPLIFY_BRANCH: ${{ vars.AWS_FRONTEND_AMPLIFY_BRANCH || 'main' }}
      AWS_FRONTEND_ARTIFACT_BUCKET: ${{ secrets.AWS_FRONTEND_ARTIFACT_BUCKET || vars.AWS_FRONTEND_ARTIFACT_BUCKET }}
      VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL_AWS }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (session token)
        if: ${{ env.AWS_SESSION_TOKEN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ env.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure AWS credentials (long-lived)
        if: ${{ env.AWS_SESSION_TOKEN == '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate required deployment inputs
        shell: bash
        run: |
          set -euo pipefail
          required=(
            AWS_FRONTEND_AMPLIFY_APP_ID
            AWS_FRONTEND_AMPLIFY_BRANCH
            AWS_FRONTEND_ARTIFACT_BUCKET
            VITE_API_BASE_URL
          )
          for key in "${required[@]}"; do
            if [[ -z "${!key}" ]]; then
              echo "::error::Missing required env/secrets: $key"
              exit 1
            fi
          done

      - name: Create GitHub deployment (frontend)
        id: gh_deployment
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              task: "deploy",
              environment: "i2g-MobileID-frontend",
              auto_merge: false,
              required_contexts: [],
              production_environment: true,
              transient_environment: false,
              description: `AWS frontend deploy run ${context.runId}`
            });
            core.setOutput("id", String(deployment.data.id));

      - name: Mark GitHub deployment in progress (frontend)
        if: ${{ steps.gh_deployment.outputs.id != '' }}
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.gh_deployment.outputs.id }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number(process.env.DEPLOYMENT_ID),
              state: "in_progress",
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: "AWS frontend deployment is running"
            });

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: pages/yarn.lock

      - name: Install dependencies
        working-directory: ./pages
        run: yarn install --frozen-lockfile --network-timeout 120000

      - name: Build frontend
        working-directory: ./pages
        run: yarn build

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          cd pages/dist
          zip -qr ../../out/frontend-dist.zip .

      - name: Upload artifact to S3
        id: artifact
        shell: bash
        run: |
          set -euo pipefail
          KEY="frontend/${GITHUB_SHA}/frontend-dist.zip"
          S3_URI="s3://${AWS_FRONTEND_ARTIFACT_BUCKET}/${KEY}"
          aws s3 cp out/frontend-dist.zip "${S3_URI}"
          SOURCE_URL="$(aws s3 presign "${S3_URI}" --expires-in 3600)"
          echo "source_url=${SOURCE_URL}" >> "$GITHUB_OUTPUT"

      - name: Ensure Amplify branch exists
        shell: bash
        run: |
          set -euo pipefail
          exists="$(aws amplify get-branch --app-id "$AWS_FRONTEND_AMPLIFY_APP_ID" --branch-name "$AWS_FRONTEND_AMPLIFY_BRANCH" --query 'branch.branchName' --output text 2>/dev/null || true)"
          if [[ -z "$exists" || "$exists" == "None" ]]; then
            aws amplify create-branch --app-id "$AWS_FRONTEND_AMPLIFY_APP_ID" --branch-name "$AWS_FRONTEND_AMPLIFY_BRANCH" >/dev/null
          fi

      - name: Start Amplify deployment
        id: deploy
        shell: bash
        run: |
          set -euo pipefail
          JOB_ID="$(aws amplify start-deployment \
            --app-id "$AWS_FRONTEND_AMPLIFY_APP_ID" \
            --branch-name "$AWS_FRONTEND_AMPLIFY_BRANCH" \
            --source-url "${{ steps.artifact.outputs.source_url }}" \
            --query 'jobSummary.jobId' \
            --output text)"

          echo "job_id=${JOB_ID}" >> "$GITHUB_OUTPUT"

      - name: Wait for Amplify deployment
        shell: bash
        run: |
          set -euo pipefail
          JOB_ID="${{ steps.deploy.outputs.job_id }}"

          for i in {1..90}; do
            STATUS="$(aws amplify get-job \
              --app-id "$AWS_FRONTEND_AMPLIFY_APP_ID" \
              --branch-name "$AWS_FRONTEND_AMPLIFY_BRANCH" \
              --job-id "$JOB_ID" \
              --query 'job.summary.status' \
              --output text)"

            case "$STATUS" in
              SUCCEED)
                echo "Amplify deployment succeeded"
                exit 0
                ;;
              FAILED|CANCELLED)
                echo "::error::Amplify deployment failed: $STATUS"
                aws amplify get-job --app-id "$AWS_FRONTEND_AMPLIFY_APP_ID" --branch-name "$AWS_FRONTEND_AMPLIFY_BRANCH" --job-id "$JOB_ID"
                exit 1
                ;;
              *)
                sleep 10
                ;;
            esac
          done

          echo "::error::Amplify deployment timed out"
          exit 1

      - name: Smoke test
        id: smoke
        shell: bash
        run: |
          set -euo pipefail
          domain="$(aws amplify get-app --app-id "$AWS_FRONTEND_AMPLIFY_APP_ID" --query 'app.defaultDomain' --output text)"
          url="https://${AWS_FRONTEND_AMPLIFY_BRANCH}.${domain}"

          for i in {1..24}; do
            code="$(curl -s -o /dev/null -w '%{http_code}' "$url" || true)"
            if [[ "$code" -ge 200 && "$code" -lt 400 ]]; then
              echo "Frontend smoke test passed: $url"
              echo "url=${url}" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep 5
          done

          echo "::error::Frontend smoke test failed: $url"
          exit 1

      - name: Mark GitHub deployment success (frontend)
        if: ${{ success() && steps.gh_deployment.outputs.id != '' }}
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.gh_deployment.outputs.id }}
          DEPLOYMENT_URL: ${{ steps.smoke.outputs.url }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number(process.env.DEPLOYMENT_ID),
              state: "success",
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              environment_url: process.env.DEPLOYMENT_URL || undefined,
              auto_inactive: false,
              description: "AWS frontend deployment succeeded"
            });

      - name: Mark GitHub deployment failure (frontend)
        if: ${{ failure() && steps.gh_deployment.outputs.id != '' }}
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.gh_deployment.outputs.id }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number(process.env.DEPLOYMENT_ID),
              state: "failure",
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: "AWS frontend deployment failed"
            });

      - name: Mark GitHub deployment cancelled (frontend)
        if: ${{ cancelled() && steps.gh_deployment.outputs.id != '' }}
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.gh_deployment.outputs.id }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number(process.env.DEPLOYMENT_ID),
              state: "inactive",
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: "AWS frontend deployment cancelled"
            });
