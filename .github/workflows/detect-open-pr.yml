name: Detect Open PR

on:
  workflow_call:
    outputs:
      should_run:
        description: "Whether the calling workflow should run its jobs"
        value: ${{ jobs.detect-open-pr.outputs.should_run }}

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-open-pr:
    name: Detect Open PR
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      pull-requests: read
      contents: read
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}

    steps:
      - name: Check for open PR
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              core.setOutput('should_run', 'true');
              return;
            }

            const { owner, repo } = context.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${branch}`,
              per_page: 1,
            });
            core.setOutput('should_run', prs.length > 0 ? 'false' : 'true');
