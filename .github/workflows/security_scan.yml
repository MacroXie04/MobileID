name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:

# Least-privilege default token permissions
permissions:
  contents: read

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  # ---------- Python Dependency Security Check ----------
  python-security:
    name: Python Security (Safety)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Safety
        run: pip install safety

      - name: Run Safety check
        working-directory: ./src
        run: |
          # Generate requirements with pinned versions
          pip install -r requirements.txt
          pip freeze > requirements-frozen.txt
          # Run safety check (always produce report)
          safety check -r requirements-frozen.txt --output json > safety-report.json || true
          # Display human-readable output
          safety check -r requirements-frozen.txt || true

      - name: Enforce Safety baseline
        working-directory: ./src
        run: |
          python - <<'PY'
          import json
          import pathlib
          import sys

          report = pathlib.Path("safety-report.json")
          if not report.exists():
              print("::error::Safety report missing")
              sys.exit(1)

          data = json.loads(report.read_text())
          vulns = data.get("vulnerabilities") or data.get("issues") or []
          if len(vulns) > 0:
              print(f"::error::Safety found {len(vulns)} vulnerabilities")
              sys.exit(1)

          print("Safety: no vulnerabilities found")
          PY

      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-report
          path: src/safety-report.json
          retention-days: 30

  # ---------- Node.js Dependency Security Check ----------
  nodejs-security:
    name: Node.js Security (Yarn Audit)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NPM_CONFIG_FETCH_RETRIES: 5
      NPM_CONFIG_FETCH_RETRY_FACTOR: 2
      NPM_CONFIG_FETCH_RETRY_MINTIMEOUT: 20000
      NPM_CONFIG_FETCH_RETRY_MAXTIMEOUT: 120000
      YARN_NETWORK_TIMEOUT: 120000

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: pages/yarn.lock

      - name: Install dependencies
        working-directory: ./pages
        run: yarn install --frozen-lockfile --network-timeout 120000

      - name: Run Yarn Audit
        working-directory: ./pages
        run: |
          # Run yarn audit and save results
          yarn audit --json > yarn-audit-report.json 2>&1 || true
          # Display summary
          yarn audit --summary || true

      - name: Enforce Yarn Audit baseline
        working-directory: ./pages
        run: |
          node - <<'NODE'
          const fs = require('fs');

          if (!fs.existsSync('yarn-audit-report.json')) {
            console.error('::error::Yarn audit report missing');
            process.exit(1);
          }

          const content = fs.readFileSync('yarn-audit-report.json', 'utf8').trim();
          if (!content) {
            console.error('::error::Yarn audit report is empty');
            process.exit(1);
          }

          let summary;
          for (const line of content.split('\n')) {
            let obj;
            try {
              obj = JSON.parse(line);
            } catch {
              continue;
            }
            if (obj.type === 'auditSummary') {
              summary = obj.data;
            }
          }

          if (!summary || !summary.vulnerabilities) {
            console.error('::error::Yarn audit summary missing');
            process.exit(1);
          }

          const { high = 0, critical = 0 } = summary.vulnerabilities;
          if (high > 0 || critical > 0) {
            console.error(`::error::Yarn audit found high=${high} critical=${critical}`);
            process.exit(1);
          }

          console.log('Yarn audit: no high/critical vulnerabilities');
          NODE

      - name: Upload Yarn Audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nodejs-security-report
          path: pages/yarn-audit-report.json
          retention-days: 30

  # ---------- Docker Image Security Scan ----------
  docker-security:
    name: Docker Security (Trivy)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          docker build -t mobileid-backend:scan ./src

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@v0.24.0
        with:
          image-ref: "mobileid-backend:scan"
          format: "table"
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Run Trivy and save JSON report
        uses: aquasecurity/trivy-action@v0.24.0
        with:
          image-ref: "mobileid-backend:scan"
          format: "json"
          output: "trivy-report.json"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-security-report
          path: trivy-report.json
          retention-days: 30

      - name: Fail on high/critical vulnerabilities
        uses: aquasecurity/trivy-action@v0.24.0
        with:
          image-ref: "mobileid-backend:scan"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

  # ---------- Summary Job ----------
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [python-security, nodejs-security, docker-security]
    if: always()

    steps:
      - name: Check security scan results
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.python-security.result }}" == "success" ]; then
            echo "[PASS] Python dependencies: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "[WARN] Python dependencies: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.nodejs-security.result }}" == "success" ]; then
            echo "[PASS] Node.js dependencies: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "[WARN] Node.js dependencies: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docker-security.result }}" == "success" ]; then
            echo "[PASS] Docker image: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "[WARN] Docker image: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
